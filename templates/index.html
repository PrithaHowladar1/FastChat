
<!DOCTYPE html>
<html>
<head>
    <title>FastAPI Chatroom</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        #chat-box {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            background-color: #ffffff;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 75%;
        }
        .self {
            background-color: #d1e7dd;
            align-self: flex-end;
            margin-left: auto;
        }
        .other {
            background-color: #e2e3e5;
            align-self: flex-start;
            margin-right: auto;
        }
        .timestamp {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 2px;
        }
        .bold-id {
            font-weight: bold;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <h2 class="mb-4">ðŸ’¬ FastChat</h2>
    <div id="auth">
        <input id="nameInput" class="form-control" placeholder="Enter your name" />
        <div class="mt-2">
            <button onclick="signup()" class="btn btn-success">Signup</button>
            <button onclick="login()" class="btn btn-primary">Login</button>
        </div>
    </div>

    <div id="chat" style="display:none;" class="mt-4">
        <h5>Your ID: <span id="ws-id"></span></h5>
        <div id="chat-box" class="d-flex flex-column mb-3"></div>
        <form onsubmit="sendMessage(event)" class="d-flex">
            <input type="text" class="form-control me-2" id="messageText" autocomplete="off" placeholder="Type a message..." />
            <button class="btn btn-outline-primary">Send</button>
        </form>
        <button onclick="leaveChat()" class="btn btn-danger mt-3">Leave Chat</button>
    </div>
</div>

<script>
    let userId = null;
    let ws = null;

    function signup() {
        const name = document.getElementById("nameInput").value;
        fetch("/signup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name })
        })
        .then(res => {
            if (!res.ok) {
                alert("Signup failed: User may already exist.");
                return;
            }
            return res.json();
        })
        .then(data => {
            if (data && data.user_id) {
                connect(data.user_id);
            }
        });
    }

    function login() {
        const name = document.getElementById("nameInput").value;
        fetch("/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name })
        })
        .then(res => {
            if (!res.ok) {
                alert("Login failed: User not found.");
                return;
            }
            return res.json();
        })
        .then(data => {
            if (data && data.user_id) {
                connect(data.user_id);
            }
        });
    }

    function connect(id) {
        userId = id;
        document.getElementById("ws-id").textContent = userId;
        document.getElementById("auth").style.display = "none";
        document.getElementById("chat").style.display = "block";

        ws = new WebSocket(`ws://localhost:8000/ws/${userId}`);
        ws.onmessage = function(event) {
            const isSystem = !event.data.includes(":");
            displayMessage(event.data, isSystem);
        };
    }

    function sendMessage(event) {
        const input = document.getElementById("messageText");
        ws.send(input.value);
        input.value = '';
        event.preventDefault();
    }

    function leaveChat() {
        if (ws) {
            ws.close();
            ws = null;
            document.getElementById("chat").style.display = "none";
            document.getElementById("auth").style.display = "block";
            alert("You have left the chat. Log in again to rejoin.");
        }
    }

    function displayMessage(text, isSystem = false) {
        const chatBox = document.getElementById("chat-box");
        const messageDiv = document.createElement("div");
        const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        messageDiv.classList.add("message");
        if (isSystem) {
            messageDiv.classList.remove("self", "other");
            messageDiv.classList.add("text-center", "text-muted");
            messageDiv.innerHTML = `<em>${text}</em><div class="timestamp">${timestamp}</div>`;
        } else {
            const [id, msg] = text.split(":");
            const boldId = `<span class="bold-id">${id.trim()}:</span>`;
            messageDiv.classList.add(text.startsWith(userId + ":") || text.startsWith("You wrote:") ? "self" : "other");
            messageDiv.innerHTML = `<div>${boldId} ${msg.trim()}</div><div class="timestamp">${timestamp}</div>`;
        }

        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>
</body>
</html>
